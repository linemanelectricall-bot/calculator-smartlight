<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Lighting Planner — Final (No Backend)</title>
<meta name="description" content="Smart Lighting Planner — Mode Lampu & Mode KKK/MCB — single file, responsive, darkmode" />
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --accent:#0077cc; --accent-2:#00aaff;
    --radius:12px; --shadow: 0 10px 30px rgba(2,6,23,0.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#0b1220;-webkit-font-smoothing:antialiased}
  .dark{background:#0b1020;color:#dfe9f5}
  .container{max-width:1100px;margin:28px auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:18px;border-radius:14px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;box-shadow:0 8px 30px rgba(0,120,200,0.14)}
  header h1{font-size:1.05rem;margin:0}
  header p{margin:0;opacity:0.92;font-size:0.9rem}
  .top-actions{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn-ghost{background:rgba(255,255,255,0.12);color:#fff;border:1px solid rgba(255,255,255,0.06)}
  .btn-light{background:#fff;color:var(--accent);border:1px solid #e6f2ff}
  .card{background:var(--card);border-radius:var(--radius);padding:18px;margin-top:18px;box-shadow:var(--shadow)}
  .dark .card{background:#0f1724;box-shadow:none}
  .tabs{display:flex;gap:8px;background:transparent;padding:6px;border-radius:10px}
  .tab{padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;border:1px solid transparent}
  .tab.active{background:linear-gradient(180deg,var(--accent-2),var(--accent));color:#fff;box-shadow:0 8px 30px rgba(0,120,200,0.12)}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  label{display:block;margin-bottom:6px;font-weight:700}
  input, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff;color:#0b1220}
  .dark input,.dark select{background:#07101a;color:#dbe9fb;border:1px solid rgba(255,255,255,0.04)}
  .row{display:flex;gap:10px}
  .row .col{flex:1}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .result{margin-top:12px;padding:12px;border-radius:8px;border:1px dashed #e6f2ff;background:#fbfeff;font-family:monospace}
  .dark .result{background:rgba(255,255,255,0.02);border-color:rgba(0,170,255,0.08)}
  svg{width:100%;height:320px;border-radius:10px;border:1px solid #e6f2ff;background:#fbfdff}
  .dark svg{background:#08101a;border-color:rgba(255,255,255,0.03)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eef4fb;text-align:left;font-size:0.95rem}
  .dark th,.dark td{border-color:rgba(255,255,255,0.03)}
  tfoot td{font-weight:800}
  .tiny{font-size:0.85rem;color:var(--muted)}
  .danger{color:#d23a3a;font-weight:800}
  .chip{padding:6px 10px;border-radius:999px;background:#f0f8ff;border:1px solid #e6f4ff;font-weight:800}
  .footer{margin-top:18px;text-align:center;color:#6b7280;font-weight:700;padding:12px}
  .small{width:120px}
  .flex-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
</style>
</head>
<body>
  <div class="container" id="app">
    <header>
      <div>
        <h1>Smart Lighting Planner — Final</h1>
        <p>Mode Lampu & Mode KKK/MCB • No backend • Responsive • Dark mode</p>
      </div>
      <div class="top-actions">
        <button class="btn btn-light" id="exportCSV" title="Export hasil Mode 2 ke CSV" style="display:none">Export CSV</button>
        <button class="btn btn-ghost" id="toggleDark">🌙</button>
      </div>
    </header>

    <div class="card">
      <div class="tabs" role="tablist">
        <button class="tab active" data-tab="mode1"> Mode 1 — Lampu (Per Titik)</button>
        <button class="tab" data-tab="mode2"> Mode 2 — KKK & MCB</button>
      </div>

      <div class="grid">
        <!-- LEFT -->
        <div style="padding:8px">
          <!-- MODE 1 -->
          <section id="mode1" aria-hidden="false">
            <h3 style="margin-top:6px">Mode 1 — Lampu (Per Titik)</h3>
            <p class="tiny">Masukkan dimensi, pilih ruangan & lampu. Bisa atur faktor daya (PF) dan derating. Visualisasi grid akan tampil di bawah.</p>

            <div style="margin-top:12px" class="grid-2">
              <div>
                <label>Kategori Ruangan</label>
                <select id="kategori"><option value="" selected disabled>-- Pilih Kategori --</option></select>
              </div>
              <div>
                <label>Jenis Ruangan</label>
                <select id="ruangan"><option value="" selected disabled>-- Pilih Ruangan --</option></select>
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <div class="col">
                <label>Panjang (m)</label>
                <input type="number" id="length" placeholder="contoh: 5" min="0" step="0.01">
              </div>
              <div class="col">
                <label>Lebar (m)</label>
                <input type="number" id="width" placeholder="contoh: 4" min="0" step="0.01">
              </div>
              <div class="small">
                <label>Efisiensi η</label>
                <input type="number" id="eta" min="0.1" max="1" step="0.01" value="0.8">
              </div>
            </div>

            <div style="margin-top:12px">
              <label>Pilih Lampu</label>
              <select id="lampSelect"><option value="" selected disabled>-- Pilih Lampu --</option></select>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="col">
                <label>Power Factor (PF)</label>
                <input type="number" id="pf1" step="0.01" min="0.5" max="1" value="0.95">
              </div>
              <div class="small">
                <label>Derating / Margin (%)</label>
                <input type="number" id="derate1" min="0" max="50" step="1" value="10">
              </div>
            </div>

            <div class="controls">
              <button class="btn btn-light" id="reset1">Reset</button>
              <button class="btn" id="calcMode1" style="background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff">Hitung &amp; Tampilkan Layout</button>
              <div style="margin-left:auto" class="chip">Mode 1</div>
            </div>

            <div id="warning1" class="tiny danger" style="margin-top:8px;display:none"></div>
            <pre id="resultMode1" class="result" style="display:none"></pre>
            <svg id="svg1" viewBox="0 0 700 450" preserveAspectRatio="xMidYMid meet"></svg>
          </section>

          <!-- MODE 2 -->
          <section id="mode2" style="display:none">
            <h3 style="margin-top:6px">Mode 2 — KKK & MCB</h3>
            <p class="tiny">Tambah grup KKK (jumlah & VA per KKK). Gunakan PF & derating untuk akurasi. Pilih phase & MCB utama jika perlu.</p>

            <div style="margin-top:10px" class="row">
              <div class="col">
                <label>Phase</label>
                <select id="phaseMode2"><option value="1">1 Phase (220V)</option><option value="3">3 Phase (380V)</option></select>
              </div>
              <div class="col">
                <label>Power Factor (default)</label>
                <input type="number" id="pf2Default" step="0.01" min="0.5" max="1" value="0.95">
              </div>
              <div class="small">
                <label>Derating (%)</label>
                <input type="number" id="derate2Default" min="0" max="50" step="1" value="10">
              </div>
            </div>

            <div id="groupsContainer" style="margin-top:12px"></div>

            <div class="controls" style="margin-top:8px">
              <button class="btn btn-light" id="addGroup">➕ Tambah Grup</button>
              <button class="btn" id="calcMode2" style="background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff">Hitung Mode 2</button>
              <button class="btn btn-ghost" id="reset2">Reset</button>
              <div style="margin-left:auto" class="chip">Mode 2</div>
            </div>

            <div id="resultMode2" class="result" style="display:none"></div>
          </section>
        </div>

        <!-- RIGHT: summary -->
        <aside style="padding:8px">
          <div class="card">
            <h4 style="margin:0 0 8px 0">Ringkasan</h4>
            <div id="summaryBox" class="tiny">Hasil perhitungan akan tampil di sini.</div>
          </div>

          <div class="card" style="margin-top:12px">
            <h4 style="margin:0 0 8px 0">Daftar Lampu (Sample)</h4>
            <div id="lampListMini" class="tiny"></div>
          </div>
        </aside>
      </div>

      <div class="footer">&copy; <span id="year"></span> by @bah</div>
    </div>
  </div>

<script>
/* ===================== DATA: ROOMS & LAMPS (diperluas) ===================== */
/* NOTE: nama menampilkan lumen / lux di dalam string (sesuai permintaan) */
const ROOMS = [
  {key:"teras_rumah", name:"Teras (Rumah Tinggal). lux: 100", kategori:"Rumah Tinggal. lux:100", lux:100},
  {key:"ruang_tamu", name:"Ruang Tamu (Rumah Tinggal). lux: 150", kategori:"Rumah Tinggal. lux:150", lux:150},
  {key:"kamar_tidur", name:"Kamar Tidur (Rumah Tinggal). lux: 150", kategori:"Rumah Tinggal. lux:150", lux:150},
  {key:"dapur", name:"Dapur (Rumah Tinggal). lux: 250", kategori:"Rumah Tinggal. lux:250", lux:250},
  {key:"garasi", name:"Garasi (Rumah Tinggal). lux: 75", kategori:"Rumah Tinggal. lux:75", lux:75},
  {key:"koridor_rumah", name:"Koridor (Rumah Tinggal). lux: 100", kategori:"Rumah Tinggal. lux:100", lux:100},

  {key:"ruang_rapat", name:"Ruang Rapat (Perkantoran). lux: 300", kategori:"Perkantoran. lux:300", lux:300},
  {key:"ruang_direktur", name:"Ruang Direktur (Perkantoran). lux: 350", kategori:"Perkantoran. lux:350", lux:350},
  {key:"open_office", name:"Open Office (Perkantoran). lux: 350", kategori:"Perkantoran. lux:350", lux:350},
  {key:"ruang_komputer", name:"Ruang Komputer (Perkantoran). lux: 500", kategori:"Perkantoran. lux:500", lux:500},
  {key:"resepsionis", name:"Resepsionis (Perkantoran). lux: 300", kategori:"Perkantoran. lux:300", lux:300},

  {key:"kelas", name:"Ruang Kelas (Lembaga Pendidikan). lux: 300", kategori:"Lembaga Pendidikan. lux:300", lux:300},
  {key:"lab_komputer", name:"Laboratorium Komputer (Lembaga Pendidikan). lux: 500", kategori:"Lembaga Pendidikan. lux:500", lux:500},
  {key:"perpustakaan", name:"Perpustakaan (Lembaga Pendidikan). lux: 300", kategori:"Lembaga Pendidikan. lux:300", lux:300},
  {key:"ruang_gambar", name:"Ruang Gambar (Lembaga Pendidikan). lux: 750", kategori:"Lembaga Pendidikan. lux:750", lux:750},

  {key:"kamar_hotel", name:"Kamar Hotel (Hotel & Restoran). lux: 150", kategori:"Hotel & Restoran. lux:150", lux:150},
  {key:"lobi_hotel", name:"Lobi Hotel (Hotel & Restoran). lux: 200", kategori:"Hotel & Restoran. lux:200", lux:200},
  {key:"ruang_makan", name:"Ruang Makan (Hotel & Restoran). lux: 200", kategori:"Hotel & Restoran. lux:200", lux:200},
  {key:"dapur_restoran", name:"Dapur Restoran (Hotel & Restoran). lux: 500", kategori:"Hotel & Restoran. lux:500", lux:500},

  {key:"ruang_operasi", name:"Ruang Operasi (Rumah Sakit). lux: 1000", kategori:"Rumah Sakit. lux:1000", lux:1000},
  {key:"icu", name:"ICU (Rumah Sakit). lux: 300", kategori:"Rumah Sakit. lux:300", lux:300},
  {key:"rawat_inap", name:"Ruang Rawat Inap (Rumah Sakit). lux: 200", kategori:"Rumah Sakit. lux:200", lux:200},
  {key:"lab_klinik", name:"Laboratorium Klinik (Rumah Sakit). lux: 750", kategori:"Rumah Sakit. lux:750", lux:750},

  {key:"produksi_kasar", name:"Produksi Kasar (Industri). lux: 200", kategori:"Industri. lux:200", lux:200},
  {key:"perakitan_presisi", name:"Perakitan Presisi (Industri). lux: 1000", kategori:"Industri. lux:1000", lux:1000},
  {key:"gudang", name:"Gudang (Industri). lux: 150", kategori:"Industri. lux:150", lux:150},
  {key:"ruang_kontrol", name:"Ruang Kontrol (Industri). lux: 500", kategori:"Industri. lux:500", lux:500},

  {key:"supermarket", name:"Supermarket (Pertokoan & Mall). lux: 750", kategori:"Pertokoan & Mall. lux:750", lux:750},
  {key:"etalase", name:"Etalase / Display (Pertokoan & Mall). lux: 1000", kategori:"Pertokoan & Mall. lux:1000", lux:1000},
  {key:"area_kasir", name:"Area Kasir (Pertokoan & Mall). lux: 500", kategori:"Pertokoan & Mall. lux:500", lux:500},
  {key:"foodcourt", name:"Foodcourt (Pertokoan & Mall). lux: 300", kategori:"Pertokoan & Mall. lux:300", lux:300},

  {key:"jalan_utama", name:"Jalan Utama (Outdoor). lux: 20", kategori:"Jalan & Transportasi. lux:20", lux:20},
  {key:"jalan_lingkungan", name:"Jalan Lingkungan (Outdoor). lux: 10", kategori:"Jalan & Transportasi. lux:10", lux:10},
  {key:"terminal", name:"Terminal (Jalan & Transportasi). lux: 150", kategori:"Jalan & Transportasi. lux:150", lux:150},
  {key:"bandara", name:"Bandara / Ruang Tunggu (Jalan & Transportasi). lux: 300", kategori:"Jalan & Transportasi. lux:300", lux:300}
];

const LAMPS = [
  {index:0,name:"LED Philips 3W. lumen: 240",watt:3,lumen:240},
  {index:1,name:"LED Philips 5W. lumen: 450",watt:5,lumen:450},
  {index:2,name:"LED Philips 7W. lumen: 600",watt:7,lumen:600},
  {index:3,name:"LED Philips 9W. lumen: 800",watt:9,lumen:800},
  {index:4,name:"LED Philips 12W. lumen: 1055",watt:12,lumen:1055},
  {index:5,name:"LED Philips 15W. lumen: 1300",watt:15,lumen:1300},
  {index:6,name:"LED Osram 10W. lumen: 900",watt:10,lumen:900},
  {index:7,name:"LED Osram 20W. lumen: 1800",watt:20,lumen:1800},
  {index:8,name:"Downlight LED 12W. lumen: 1000",watt:12,lumen:1000},
  {index:9,name:"Downlight LED 18W. lumen: 1500",watt:18,lumen:1500},
  {index:10,name:"Lampu TL 36W. lumen: 3350",watt:36,lumen:3350},
  {index:11,name:"Lampu TL 58W. lumen: 4000",watt:58,lumen:4000},
  {index:12,name:"Floodlight LED 30W. lumen: 2700",watt:30,lumen:2700},
  {index:13,name:"Floodlight LED 50W. lumen: 4500",watt:50,lumen:4500},
  {index:14,name:"Floodlight LED 70W. lumen: 6300",watt:70,lumen:6300},
  {index:15,name:"Floodlight LED 100W. lumen: 9000",watt:100,lumen:9000},
  {index:16,name:"Spotlight LED 5W. lumen: 400",watt:5,lumen:400},
  {index:17,name:"Spotlight LED 10W. lumen: 900",watt:10,lumen:900}
];

/* ===================== DOM refs & initial populate ===================== */
const kategoriEl = document.getElementById('kategori');
const ruanganEl = document.getElementById('ruangan');
const lampSelect = document.getElementById('lampSelect');
const lampListMini = document.getElementById('lampListMini');
const summaryBox = document.getElementById('summaryBox');
const svg1 = document.getElementById('svg1');
const resultMode1 = document.getElementById('resultMode1');
const warning1 = document.getElementById('warning1');

const phaseMode2 = document.getElementById('phaseMode2');
const groupsContainer = document.getElementById('groupsContainer');
const resultMode2 = document.getElementById('resultMode2');
const exportCSVbtn = document.getElementById('exportCSV');

/* populate kategori */
[...new Set(ROOMS.map(r=>r.kategori))].forEach(k=>{
  const o = document.createElement('option'); o.value = k; o.textContent = k; kategoriEl.appendChild(o);
});
kategoriEl.addEventListener('change', ()=>{
  ruanganEl.innerHTML = '<option disabled selected>-- Pilih Ruangan --</option>';
  ROOMS.filter(r => r.kategori === kategoriEl.value).forEach(r=>{
    const o = document.createElement('option'); o.value = r.key; o.textContent = r.name; ruanganEl.appendChild(o);
  });
});

/* populate lamps */
LAMPS.forEach(l=>{
  const o = document.createElement('option'); o.value = l.index; o.textContent = l.name; lampSelect.appendChild(o);
  const d = document.createElement('div'); d.textContent = `${l.name} • ${l.watt}W • ${l.lumen} lm`; d.style.padding='6px 0'; lampListMini.appendChild(d);
});

/* tabs */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    e.currentTarget.classList.add('active');
    const tab = e.currentTarget.dataset.tab;
    document.getElementById('mode1').style.display = (tab==='mode1')? 'block':'none';
    document.getElementById('mode2').style.display = (tab==='mode2')? 'block':'none';
    summaryBox.textContent = (tab==='mode1')? 'Mode 1 aktif — hitung jumlah lampu dan layout.' : 'Mode 2 aktif — tambah grup KKK & hitung MCB.';
  });
});

/* dark toggle */
document.getElementById('toggleDark').addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  document.getElementById('toggleDark').textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
});

/* helper: recommend MCB sizes (common B/C curve sizes) with derating rule (80%) */
const MCB_SIZES = [2,4,6,10,16,20,25,32,40,50,63,80,100,125];

function recommendMCB(amp, safetyFactor = 0.8){
  // choose smallest MCB where rated*factor >= amp
  for(const s of MCB_SIZES){
    if(s * safetyFactor >= amp) return s;
  }
  return MCB_SIZES[MCB_SIZES.length - 1];
}

/* ===================== MODE 1: Calculation & SVG layout ===================== */
document.getElementById('calcMode1').addEventListener('click', ()=>{
  // gather inputs
  const ruKey = ruanganEl.value;
  const lampIdx = parseInt(lampSelect.value);
  const length = parseFloat(document.getElementById('length').value);
  const width = parseFloat(document.getElementById('width').value);
  const eta = parseFloat(document.getElementById('eta').value) || 0.8;
  const pf = parseFloat(document.getElementById('pf1').value) || 0.95;
  const deratePct = parseFloat(document.getElementById('derate1').value) || 0;

  if(!ruKey || isNaN(lampIdx) || isNaN(length) || isNaN(width)){ alert('Lengkapi semua input Mode 1!'); return; }

  const room = ROOMS.find(r=>r.key === ruKey);
  const lamp = LAMPS.find(l=>l.index === lampIdx);
  const area = length * width;
  const requiredLumens = (room.lux * area) / eta; // total luminous flux required
  const lampCount = Math.max(1, Math.ceil(requiredLumens / lamp.lumen));
  const totalWatt = lamp.watt * lampCount; // active power (W)
  const apparentVA = totalWatt / pf; // VA considering PF
  const derateFactor = 1 + (deratePct/100);
  const vaWithDerate = apparentVA * derateFactor;
  const currentA = vaWithDerate / 220;

  // spacing/layout calculation (attempt square grid)
  const cols = Math.ceil(Math.sqrt(lampCount));
  const rows = Math.ceil(lampCount / cols);
  const spacingX = 700 / (cols + 1);
  const spacingY = 450 / (rows + 1);
  const points = [];
  let uneven = false;
  let placed = 0;
  for(let r=0;r<rows;r++){
    const rowCount = (r < rows-1) ? cols : (lampCount - cols*(rows-1));
    if(rowCount !== cols) uneven = true;
    // center the row
    const offsetX = (700 - (rowCount * spacingX)) / 2 + spacingX;
    for(let c=0;c<rowCount;c++){
      if(placed >= lampCount) break;
      const cx = Math.round(offsetX + c*spacingX);
      const cy = Math.round(spacingY + r*spacingY);
      points.push({x:cx,y:cy,index:placed+1});
      placed++;
    }
  }

  // render svg
  renderSVG(points);

  // estimate distance to wall (simple): assume uniform spacing; distance to nearest wall ~ spacing/2
  const estSpacingM_X = length / (cols+1);
  const estSpacingM_Y = width / (rows+1);
  const estWallDist = Math.min(estSpacingM_X, estSpacingM_Y);

  // output
  const out = [];
  out.push(`Ruangan: ${room.name}`);
  out.push(`Luas: ${area.toFixed(2)} m²`);
  out.push(`Lux Standar: ${room.lux} lx`);
  out.push(`Lampu Pilihan: ${lamp.name} (${lamp.watt}W | ${lamp.lumen} lm)`);
  out.push(`Jumlah Lampu: ${lampCount} buah`);
  out.push(`Total Watt (P): ${totalWatt} W`);
  out.push(`Total VA (dengan PF ${pf.toFixed(2)}): ${apparentVA.toFixed(2)} VA`);
  out.push(`VA setelah derating ${deratePct}%: ${vaWithDerate.toFixed(2)} VA`);
  out.push(`Arus (A) pada 220V: ${currentA.toFixed(2)} A`);
  out.push(`Grid: ${cols} x ${rows} (kolom x baris)${uneven? ' — peringatan: baris terakhir tidak merata':''}`);
  out.push(`Estimasi jarak antar titik (m): ≈ ${estSpacingM_X.toFixed(2)}m (X), ${estSpacingM_Y.toFixed(2)}m (Y)`);
  out.push(`Estimasi jarak lampu ke dinding (m): ≈ ${estWallDist.toFixed(2)} m`);

  resultMode1.style.display = 'block';
  resultMode1.textContent = out.join('\n');

  warning1.style.display = uneven ? 'block' : 'none';
  warning1.textContent = uneven ? '⚠ Peringatan: jumlah lampu per baris tidak merata. Pertimbangkan jumlah lampu atau tipe lampu lain untuk simetri.' : '';

  summaryBox.innerHTML = `<strong>Mode 1</strong><br>Jumlah lampu: ${lampCount} • Total Watt: ${totalWatt} W • Arus: ${currentA.toFixed(2)} A`;
});

/* render SVG helper */
function renderSVG(points){
  svg1.innerHTML = '';
  // border room rectangle
  const svgNS = 'http://www.w3.org/2000/svg';
  const rect = document.createElementNS(svgNS,'rect');
  rect.setAttribute('x',6); rect.setAttribute('y',6); rect.setAttribute('width',688); rect.setAttribute('height',438); rect.setAttribute('rx',10);
  rect.setAttribute('fill','#fff'); rect.setAttribute('stroke','#e6f4ff'); svg1.appendChild(rect);
  // place points
  points.forEach(p=>{
    const g = document.createElementNS(svgNS,'g');
    const c = document.createElementNS(svgNS,'circle'); c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); c.setAttribute('r',10);
    c.setAttribute('fill','#00aaff'); c.setAttribute('stroke','#0077cc'); c.setAttribute('stroke-width',2);
    const t = document.createElementNS(svgNS,'text'); t.setAttribute('x',p.x); t.setAttribute('y',p.y+28); t.setAttribute('text-anchor','middle');
    t.setAttribute('font-size','12'); t.setAttribute('fill','#0b1220'); t.textContent = p.index;
    g.appendChild(c); g.appendChild(t); svg1.appendChild(g);
  });
}

/* reset Mode1 */
document.getElementById('reset1').addEventListener('click', ()=>{
  document.getElementById('length').value=''; document.getElementById('width').value=''; document.getElementById('lampSelect').selectedIndex = 0;
  resultMode1.style.display='none'; svg1.innerHTML=''; warning1.style.display='none'; summaryBox.textContent = 'Ringkasan akan tampil di sini.';
});

/* ===================== MODE 2: Groups & MCB calculation ===================== */
/* group row factory */
function createGroupRow(idx, initialCount=1, initialVA=450, initialPF=0.95, initialDerate=10){
  const wrapper = document.createElement('div');
  wrapper.className = 'card';
  wrapper.style.marginBottom = '10px';
  wrapper.innerHTML = `
    <div class="flex-between">
      <strong>KKK #${idx}</strong>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-ghost btn-remove">Hapus</button>
      </div>
    </div>
    <div style="margin-top:10px" class="row">
      <div class="col">
        <label>Jumlah KKK</label>
        <input type="number" class="g_count" value="${initialCount}" min="1">
      </div>
      <div class="col">
        <label>VA per KKK (VA)</label>
        <input type="number" class="g_va" value="${initialVA}" min="1">
      </div>
      <div class="col">
        <label>Power Factor (PF)</label>
        <input type="number" class="g_pf" step="0.01" min="0.5" max="1" value="${initialPF}">
      </div>
      <div class="small">
        <label>Derating %</label>
        <input type="number" class="g_derate" min="0" max="50" value="${initialDerate}">
      </div>
    </div>
  `;
  wrapper.querySelector('.btn-remove').addEventListener('click', ()=>{wrapper.remove(); updateGroupIndices();});
  groupsContainer.appendChild(wrapper);
  updateGroupIndices();
}
function updateGroupIndices(){
  Array.from(groupsContainer.children).forEach((c,i)=>{
    const strong = c.querySelector('strong'); if(strong) strong.textContent = `KKK #${i+1}`;
  });
}

/* init: add one default group */
createGroupRow(1);

/* add group button */
document.getElementById('addGroup').addEventListener('click', ()=>{
  createGroupRow(groupsContainer.children.length + 1, 1, 450, parseFloat(document.getElementById('pf2Default').value)||0.95, parseFloat(document.getElementById('derate2Default').value)||10);
});

/* reset mode2 */
document.getElementById('reset2').addEventListener('click', ()=>{
  groupsContainer.innerHTML = ''; resultMode2.style.display='none'; exportCSVbtn.style.display='none'; summaryBox.textContent = 'Ringkasan akan tampil di sini.'; createGroupRow(1);
});

/* calc mode2 */
document.getElementById('calcMode2').addEventListener('click', ()=>{
  const phase = parseInt(phaseMode2.value,10);
  const rows = Array.from(groupsContainer.children);
  if(rows.length === 0){ alert('Tambahkan minimal 1 grup KKK.'); return; }

  const results = [];
  let totalKKK = 0, totalVA = 0, totalAmpSum = 0;

  rows.forEach((row, idx) => {
    const count = parseInt(row.querySelector('.g_count').value,10) || 0;
    const vaPer = parseFloat(row.querySelector('.g_va').value) || 0;
    const pf = parseFloat(row.querySelector('.g_pf').value) || (parseFloat(document.getElementById('pf2Default').value) || 0.95);
    const deratePct = parseFloat(row.querySelector('.g_derate').value) || (parseFloat(document.getElementById('derate2Default').value) || 10);

    // total VA before pf/derate
    const groupVA_raw = vaPer * count;
    // convert to apparent VA considering PF: P = VA * PF  => VA_apparent = P / PF -> but vaPer is already VA per KKK (use as VA)
    // We'll treat vaPer as VA (apparent) for KKK load. Then adjust by derating (safety margin)
    const derateFactor = 1 + (deratePct / 100);
    const groupVA = groupVA_raw * derateFactor;
    // compute current:
    let amp = 0;
    if(phase === 1){
      amp = groupVA / 220; // single phase 220V
    } else {
      // approximate three-phase current: I = VA / (√3 * Vline)
      amp = groupVA / (Math.sqrt(3) * 380);
    }
    const mcb = recommendMCB(amp, 0.8);
    results.push({group: idx+1, count, vaPer, groupVA: Math.round(groupVA), amp, mcb, pf, deratePct});
    totalKKK += count; totalVA += groupVA; totalAmpSum += amp;
  });

  // main MCB if needed (use sum of amps)
  const mainMCB = recommendMCB(totalAmpSum, 0.8);

  // render table
  let html = `<table><thead><tr><th>Grup</th><th>Jumlah KKK</th><th>VA per KKK</th><th>Total VA (derated)</th><th>Arus (A)</th><th>Rekom. MCB (A)</th></tr></thead><tbody>`;
  results.forEach(r=>{
    html += `<tr><td>${r.group}</td><td>${r.count}</td><td>${r.vaPer}</td><td>${r.groupVA}</td><td>${r.amp.toFixed(2)}</td><td>${r.mcb}</td></tr>`;
  });
  html += `</tbody><tfoot><tr><td>Total</td><td>${totalKKK}</td><td>-</td><td>${Math.round(totalVA)}</td><td>${totalAmpSum.toFixed(2)}</td><td>${mainMCB} (Utama)</td></tr></tfoot></table>`;
  resultMode2.style.display = 'block';
  resultMode2.innerHTML = html;
  summaryBox.innerHTML = `<strong>Mode 2</strong><br>Grup: ${results.length} • Total KKK: ${totalKKK} • Total VA (derated): ${Math.round(totalVA)} • Total Arus: ${totalAmpSum.toFixed(2)} A • MCB Utama: ${mainMCB} A`;

  // enable export
  exportCSVbtn.style.display = 'inline-block';
  exportCSVbtn.onclick = ()=>{ downloadCSV(results, {phase, totalKKK, totalVA: Math.round(totalVA), totalAmpSum, mainMCB}); };
});

/* CSV exporter */
function downloadCSV(rows, meta){
  const header = ['Grup','Jumlah KKK','VA per KKK','Total VA (derated)','Arus (A)','Rekomendasi MCB (A)'];
  const lines = [header.join(',')];
  rows.forEach(r=>{
    lines.push([r.group, r.count, r.vaPer, r.groupVA, r.amp.toFixed(2), r.mcb].join(','));
  });
  lines.push([]);
  lines.push(['Phase', meta.phase]);
  lines.push(['Total KKK', meta.totalKKK]);
  lines.push(['Total VA (derated)', meta.totalVA]);
  lines.push(['Total Ampere', meta.totalAmpSum.toFixed(2)]);
  lines.push(['MCB Utama', meta.mainMCB]);

  const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'mode2_results.csv'; a.click(); URL.revokeObjectURL(url);
}

/* init: hide export until results */
exportCSVbtn.style.display = 'none';

/* ===================== small UX helpers ===================== */
document.getElementById('year').textContent = new Date().getFullYear();

/* keyboard improvements: allow Enter to compute on inputs in mode1 */
['length','width','eta','pf1','derate1'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') document.getElementById('calcMode1').click(); });
});
</script>
</body>
</html>
