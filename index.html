<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Lighting Planner Premium</title>
<style>
:root {
  --primary: #00aaff;
  --primary-dark: #0077cc;
  --bg-light: #f5f7fa;
  --bg-dark: #1e1e2f;
  --text-light: #fff;
  --text-dark: #333;
  --card-light: #fff;
  --card-dark: #2b2b3c;
  --border-light: #ccc;
  --border-dark: #444;
}

body {
  margin: 0; padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-light);
  color: var(--text-dark);
  transition: 0.4s;
}

body.dark {
  background: var(--bg-dark);
  color: var(--text-light);
}

header {
  background: linear-gradient(90deg, var(--primary-dark), var(--primary));
  color: #fff;
  text-align: center;
  padding: 35px 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  position: relative;
}

header h1 {
  font-size: 2em; margin: 0;
}

header p {
  opacity: 0.9;
}

#toggleDark {
  position: absolute;
  right: 15px; top: 15px;
  background: rgba(255,255,255,0.2);
  border: none; color: #fff;
  padding: 8px 15px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}
#toggleDark:hover { background: rgba(255,255,255,0.3); }

.wrap {
  max-width: 1100px; margin: 25px auto; padding: 0 20px;
}

.card {
  background: var(--card-light);
  color: inherit;
  border-radius: 15px;
  padding: 25px;
  margin-bottom: 25px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  transition: 0.3s;
}
body.dark .card { background: var(--card-dark); box-shadow: 0 4px 15px rgba(255,255,255,0.05); }

.btn {
  border: none;
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  margin: 5px;
  transition: 0.3s;
}
.btn:hover { transform: translateY(-2px); }
.mode-btn {
  background: var(--primary-dark);
  color: #fff;
}
.mode-btn.active { background: var(--primary); }

button.primary { background: var(--primary); color: #fff; }
button.outline {
  background: transparent;
  border: 2px solid var(--primary);
  color: var(--primary);
}
body.dark button.outline { border-color: #00aaff; color: #00aaff; }

.grid-2 {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(250px,1fr));
  gap: 20px;
}

label { display: block; margin-bottom: 6px; font-weight: 600; }
input, select {
  width: 100%; padding: 10px;
  border: 1px solid var(--border-light);
  border-radius: 10px;
  font-size: 1em;
}
body.dark input, body.dark select {
  background: #333;
  color: #fff;
  border-color: var(--border-dark);
}
.result-block {
  margin-top: 15px;
  padding: 15px;
  border-radius: 10px;
  background: rgba(0,0,0,0.05);
  white-space: pre-wrap;
  font-family: monospace;
}
body.dark .result-block { background: rgba(255,255,255,0.05); }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
table th, table td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
}
body.dark table th, body.dark table td {
  border-color: #444;
}
table th {
  background: var(--primary);
  color: #fff;
}
canvas, svg {
  width: 100%; height: auto;
  margin-top: 15px;
  border-radius: 10px;
  border: 1px solid var(--primary);
}
.hidden { display: none; }

footer {
  text-align: center;
  padding: 20px;
  font-weight: 600;
  background: rgba(0,0,0,0.05);
  border-top: 1px solid #ccc;
  margin-top: 30px;
}
body.dark footer { background: rgba(255,255,255,0.05); border-top-color: #444; }

.warning { color: red; font-weight: 700; margin-top: 10px; }
body.dark .warning { color: #ff8080; }

@media(max-width:600px){
  header h1{font-size:1.6em;}
  .btn{padding:8px 15px;}
  table{font-size:0.9em; overflow-x:auto; display:block;}
}
</style>
</head>
<body>
<header>
  <h1>Smart Lighting Planner Premium</h1>
  <p>Hitung Lampu, Layout, Watt & MCB dengan Akurasi SNI</p>
  <button id="toggleDark">üåô</button>
</header>

<div class="wrap">
  <div class="card" style="text-align:center;">
    <button class="btn mode-btn active" id="btnMode1">Hitung‚Äî Lampu (per titik)</button>
    <button class="btn mode-btn" id="btnMode2"> KKK & lampu - MCB</button>
  </div>

  <!-- MODE 1 -->
  <div id="mode1" class="card">
    <div class="grid-2">
      <div>
        <label>Kategori Ruangan</label>
        <select id="kategori"></select>
      </div>
      <div>
        <label>Jenis Ruangan</label>
        <select id="ruangan"></select>
      </div>
      <div>
        <label>Panjang (m)</label>
        <input type="number" id="length" placeholder="5">
      </div>
      <div>
        <label>Lebar (m)</label>
        <input type="number" id="width" placeholder="4">
      </div>
      <div>
        <label>Efisiensi Œ∑</label>
        <input type="number" id="eta" value="0.8" step="0.01">
      </div>
      <div>
        <label>Pilih Lampu</label>
        <select id="lampSelect"></select>
      </div>
    </div>
    <button class="btn primary" id="calcMode1">Hitung & Layout</button>
    <button class="btn outline" id="reset1">Reset</button>
    <div class="warning hidden" id="warning1"></div>
    <div id="resultMode1" class="result-block"></div>
    <svg id="lampLayout" viewBox="0 0 600 400"></svg>
  </div>

  <!-- MODE 2 -->
  <div id="mode2" class="card hidden">
    <div id="groupsContainer"></div>
    <button class="btn outline" id="addGroup">‚ûï Tambah Grup Lampu</button>
    <button class="btn primary" id="calcMode2">Hitung Mode 2</button>
    <div id="resultMode2" class="result-block"></div>
    <div style="overflow-x:auto;">
      <table id="resultTable">
        <thead>
          <tr><th>Grup</th><th>Jumlah Lampu</th><th>Lampu</th><th>Total Watt</th><th>Total VA</th><th>Arus (A)</th><th>Rek. MCB</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<footer>&copy; <span id="year"></span> by @bah</footer>

<script>
// ===== DARK MODE =====
const toggleDark=document.getElementById('toggleDark');
toggleDark.addEventListener('click',()=>{document.body.classList.toggle('dark');toggleDark.textContent=document.body.classList.contains('dark')?'‚òÄÔ∏è':'üåô';});

// ===== DATA =====
const ROOMS=[
  {key:"teras_rumah", name:"Teras (Rumah Tinggal). lux: 100", kategori:"Rumah Tinggal. lux:100", lux:100},
  {key:"ruang_tamu", name:"Ruang Tamu (Rumah Tinggal). lux: 150", kategori:"Rumah Tinggal. lux:150", lux:150},
  {key:"kamar_tidur", name:"Kamar Tidur (Rumah Tinggal). lux: 150", kategori:"Rumah Tinggal. lux:150", lux:150},
  {key:"dapur", name:"Dapur (Rumah Tinggal). lux: 250", kategori:"Rumah Tinggal. lux:250", lux:250},
  {key:"garasi", name:"Garasi (Rumah Tinggal). lux: 75", kategori:"Rumah Tinggal. lux:75", lux:75},
  {key:"koridor_rumah", name:"Koridor (Rumah Tinggal). lux: 100", kategori:"Rumah Tinggal. lux:100", lux:100},

  {key:"ruang_rapat", name:"Ruang Rapat (Perkantoran). lux: 300", kategori:"Perkantoran. lux:300", lux:300},
  {key:"ruang_direktur", name:"Ruang Direktur (Perkantoran). lux: 350", kategori:"Perkantoran. lux:350", lux:350},
  {key:"open_office", name:"Open Office (Perkantoran). lux: 350", kategori:"Perkantoran. lux:350", lux:350},
  {key:"ruang_komputer", name:"Ruang Komputer (Perkantoran). lux: 500", kategori:"Perkantoran. lux:500", lux:500},
  {key:"resepsionis", name:"Resepsionis (Perkantoran). lux: 300", kategori:"Perkantoran. lux:300", lux:300},

  {key:"kelas", name:"Ruang Kelas (Lembaga Pendidikan). lux: 300", kategori:"Lembaga Pendidikan. lux:300", lux:300},
  {key:"lab_komputer", name:"Laboratorium Komputer (Lembaga Pendidikan). lux: 500", kategori:"Lembaga Pendidikan. lux:500", lux:500},
  {key:"perpustakaan", name:"Perpustakaan (Lembaga Pendidikan). lux: 300", kategori:"Lembaga Pendidikan. lux:300", lux:300},
  {key:"ruang_gambar", name:"Ruang Gambar (Lembaga Pendidikan). lux: 750", kategori:"Lembaga Pendidikan. lux:750", lux:750},

  {key:"kamar_hotel", name:"Kamar Hotel (Hotel & Restoran). lux: 150", kategori:"Hotel & Restoran. lux:150", lux:150},
  {key:"lobi_hotel", name:"Lobi Hotel (Hotel & Restoran). lux: 200", kategori:"Hotel & Restoran. lux:200", lux:200},
  {key:"ruang_makan", name:"Ruang Makan (Hotel & Restoran). lux: 200", kategori:"Hotel & Restoran. lux:200", lux:200},
  {key:"dapur_restoran", name:"Dapur Restoran (Hotel & Restoran). lux: 500", kategori:"Hotel & Restoran. lux:500", lux:500},

  {key:"ruang_operasi", name:"Ruang Operasi (Rumah Sakit). lux: 1000", kategori:"Rumah Sakit. lux:1000", lux:1000},
  {key:"icu", name:"ICU (Rumah Sakit). lux: 300", kategori:"Rumah Sakit. lux:300", lux:300},
  {key:"rawat_inap", name:"Ruang Rawat Inap (Rumah Sakit). lux: 200", kategori:"Rumah Sakit. lux:200", lux:200},
  {key:"lab_klinik", name:"Laboratorium Klinik (Rumah Sakit). lux: 750", kategori:"Rumah Sakit. lux:750", lux:750},

  {key:"produksi_kasar", name:"Produksi Kasar (Industri). lux: 200", kategori:"Industri. lux:200", lux:200},
  {key:"perakitan_presisi", name:"Perakitan Presisi (Industri). lux: 1000", kategori:"Industri. lux:1000", lux:1000},
  {key:"gudang", name:"Gudang (Industri). lux: 150", kategori:"Industri. lux:150", lux:150},
  {key:"ruang_kontrol", name:"Ruang Kontrol (Industri). lux: 500", kategori:"Industri. lux:500", lux:500},

  {key:"supermarket", name:"Supermarket (Pertokoan & Mall). lux: 750", kategori:"Pertokoan & Mall. lux:750", lux:750},
  {key:"etalase", name:"Etalase / Display (Pertokoan & Mall). lux: 1000", kategori:"Pertokoan & Mall. lux:1000", lux:1000},
  {key:"area_kasir", name:"Area Kasir (Pertokoan & Mall). lux: 500", kategori:"Pertokoan & Mall. lux:500", lux:500},
  {key:"foodcourt", name:"Foodcourt (Pertokoan & Mall). lux: 300", kategori:"Pertokoan & Mall. lux:300", lux:300},

  {key:"jalan_utama", name:"Jalan Utama (Outdoor). lux: 20", kategori:"Jalan & Transportasi. lux:20", lux:20},
  {key:"jalan_lingkungan", name:"Jalan Lingkungan (Outdoor). lux: 10", kategori:"Jalan & Transportasi. lux:10", lux:10},
  {key:"terminal", name:"Terminal (Jalan & Transportasi). lux: 150", kategori:"Jalan & Transportasi. lux:150", lux:150},
  {key:"bandara", name:"Bandara / Ruang Tunggu (Jalan & Transportasi). lux: 300", kategori:"Jalan & Transportasi. lux:300", lux:300}
];

const LAMPS = [
  {index:0,name:"LED Philips 3W. lumen: 240",watt:3,lumen:240},
  {index:1,name:"LED Philips 5W. lumen: 450",watt:5,lumen:450},
  {index:2,name:"LED Philips 7W. lumen: 600",watt:7,lumen:600},
  {index:3,name:"LED Philips 9W. lumen: 800",watt:9,lumen:800},
  {index:4,name:"LED Philips 12W. lumen: 1055",watt:12,lumen:1055},
  {index:5,name:"LED Philips 15W. lumen: 1300",watt:15,lumen:1300},
  {index:6,name:"LED Osram 10W. lumen: 900",watt:10,lumen:900},
  {index:7,name:"LED Osram 20W. lumen: 1800",watt:20,lumen:1800},
  {index:8,name:"Downlight LED 12W. lumen: 1000",watt:12,lumen:1000},
  {index:9,name:"Downlight LED 18W. lumen: 1500",watt:18,lumen:1500},
  {index:10,name:"Lampu TL 36W. lumen: 3350",watt:36,lumen:3350},
  {index:11,name:"Lampu TL 58W. lumen: 4000",watt:58,lumen:4000},
  {index:12,name:"Floodlight LED 30W. lumen: 2700",watt:30,lumen:2700},
  {index:13,name:"Floodlight LED 50W. lumen: 4500",watt:50,lumen:4500},
  {index:14,name:"Floodlight LED 70W. lumen: 6300",watt:70,lumen:6300},
  {index:15,name:"Floodlight LED 100W. lumen: 9000",watt:100,lumen:9000},
  {index:16,name:"Spotlight LED 5W. lumen: 400",watt:5,lumen:400},
  {index:17,name:"Spotlight LED 10W. lumen: 900",watt:10,lumen:900}
];


// ===== DROPDOWN =====
const kategoriEl=document.getElementById("kategori");
const ruanganEl=document.getElementById("ruangan");
const lampSelect=document.getElementById("lampSelect");

const kategoriList=[...new Set(ROOMS.map(r=>r.kategori))];
kategoriList.forEach(k=>{
  const opt=document.createElement("option");
  opt.value=k; opt.textContent=k;
  kategoriEl.appendChild(opt);
});
kategoriEl.addEventListener("change",()=>{
  ruanganEl.innerHTML='<option value="">-- Pilih Ruangan --</option>';
  ROOMS.filter(r=>r.kategori==kategoriEl.value).forEach(r=>{
    const o=document.createElement("option");
    o.value=r.key; o.textContent=r.name;
    ruanganEl.appendChild(o);
  });
});
LAMPS.forEach(l=>{
  const o=document.createElement("option");
  o.value=l.index;
  o.textContent=l.name+` [${l.watt}W | ${l.lumen}lm]`;
  lampSelect.appendChild(o);
});

// ===== MODE TOGGLE =====
const mode1=document.getElementById("mode1");
const mode2=document.getElementById("mode2");
const btn1=document.getElementById("btnMode1");
const btn2=document.getElementById("btnMode2");
btn1.onclick=()=>{mode1.classList.remove('hidden');mode2.classList.add('hidden');btn1.classList.add('active');btn2.classList.remove('active');};
btn2.onclick=()=>{mode2.classList.remove('hidden');mode1.classList.add('hidden');btn2.classList.add('active');btn1.classList.remove('active');};

// ===== MODE 1 =====
document.getElementById("calcMode1").onclick=()=>{
  const rKey=ruanganEl.value;
  const lIdx=parseInt(lampSelect.value);
  const len=parseFloat(document.getElementById("length").value);
  const wid=parseFloat(document.getElementById("width").value);
  const eta=parseFloat(document.getElementById("eta").value);
  const warn=document.getElementById("warning1");
  const result=document.getElementById("resultMode1");
  const svg=document.getElementById("lampLayout");
  if(!rKey||isNaN(lIdx)||!len||!wid){alert("Lengkapi semua input!");return;}
  const ruangan=ROOMS.find(r=>r.key==rKey);
  const lamp=LAMPS.find(l=>l.index==lIdx);
  const area=len*wid;
  const totalLum=ruangan.lux*area/eta;
  const lampCount=Math.ceil(totalLum/lamp.lumen);
  const totalWatt=lamp.watt*lampCount;
  const arus=totalWatt/220;
  const cols=Math.ceil(Math.sqrt(lampCount)),rows=Math.ceil(lampCount/cols);
  svg.innerHTML="";
  for(let i=0;i<lampCount;i++){
    const r=Math.floor(i/cols),c=i%cols;
    const cx=((c+1)/(cols+1))*600;
    const cy=((r+1)/(rows+1))*400;
    const circle=document.createElementNS("http://www.w3.org/2000/svg","circle");
    circle.setAttribute("cx",cx);
    circle.setAttribute("cy",cy);
    circle.setAttribute("r",10);
    circle.setAttribute("fill",i%2==0?"#00aaff":"#0077cc");
    svg.appendChild(circle);
  }
  warn.classList.add("hidden");
  if(lampCount%cols!==0){warn.textContent="‚ö† Jumlah lampu tidak merata, pertimbangkan watt lain.";warn.classList.remove("hidden");}
  result.textContent=`Ruangan: ${ruangan.name}\nLuas: ${area.toFixed(2)} m¬≤\nLux: ${ruangan.lux}\nLampu: ${lamp.name}\nJumlah: ${lampCount}\nTotal Watt: ${totalWatt}W\nArus: ${arus.toFixed(2)}A`;
};
document.getElementById("reset1").onclick=()=>{document.querySelectorAll("#mode1 input, #mode1 select").forEach(i=>i.value="");document.getElementById("lampLayout").innerHTML="";document.getElementById("resultMode1").textContent="";};

<script>
// ===== MODE 2 (FINAL VERSION) =====
const groupsContainer = document.getElementById('groupsContainer');
const calcMode2Btn = document.getElementById('calcMode2');
const resultTableBody = document.querySelector('#resultTable tbody');
const resultMode2 = document.getElementById('resultMode2');

// === Tambahkan kontrol sistem fase ===
const sysSelector = document.createElement('div');
sysSelector.style.marginBottom = "15px";
sysSelector.innerHTML = `
  <label><b>Sistem Listrik:</b></label>
  <select id="sistemListrik" style="padding:8px;border-radius:8px;border:1px solid #ccc;margin-left:10px">
    <option value="1">1 Fase (220V)</option>
    <option value="3">3 Fase (380V)</option>
  </select>
  <button id="addGroup" class="btn outline" style="margin-left:12px;">‚ûï Tambah Grup</button>
  <button id="addExample" class="btn outline">‚ú® Tambah Grup Contoh</button>
`;
groupsContainer.parentNode.insertBefore(sysSelector, groupsContainer);

let grpIdCounter = 0;

function recommendMCB(amp) {
  const sizes = [2,4,6,10,16,20,25,32,40,50,63,80,100];
  for (const s of sizes) if (amp <= s * 0.8) return s;
  return sizes[sizes.length - 1];
}

function makeLampOptionsHTML() {
  return LAMPS.map(l => `<option value="${l.index}">${l.name} [${l.watt}W]</option>`).join('');
}

function createGroupCard() {
  grpIdCounter++;
  const id = grpIdCounter;
  const card = document.createElement('div');
  card.className = 'card mode2-group';
  card.dataset.gid = id;
  card.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <strong>Grup ${id}</strong>
      <div style="display:flex;gap:8px">
        <button class="btn outline add-lamp">‚ûï Lampu</button>
        <button class="btn outline add-kkk">‚ûï KKK (VA)</button>
        <button class="btn outline remove-group">üóë Hapus Grup</button>
      </div>
    </div>

    <div class="grid-2" style="margin-top:10px">
      <div>
        <label>Power Factor (PF)</label>
        <input type="number" class="g_pf" step="0.01" min="0.5" max="1" value="0.95">
      </div>
      <div>
        <label>Derating / Margin (%)</label>
        <input type="number" class="g_derate" min="0" max="50" step="1" value="10">
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="lamp-rows"></div>
      <div class="kkk-rows" style="margin-top:8px"></div>
    </div>

    <div style="margin-top:10px" class="tiny">Hasil Grup: <span class="group-summary">-</span></div>
  `;
  groupsContainer.appendChild(card);

  card.querySelector('.add-lamp').addEventListener('click', ()=> addLampRow(card));
  card.querySelector('.add-kkk').addEventListener('click', ()=> addKKKRow(card));
  card.querySelector('.remove-group').addEventListener('click', ()=> { if(confirm('Hapus grup ini?')) card.remove(); });
  return card;
}

function addLampRow(card, defaultQty=1, defaultLampIndex=0) {
  const rows = card.querySelector('.lamp-rows');
  const row = document.createElement('div');
  row.className = 'lamp-row';
  row.style.cssText = 'display:flex;gap:8px;margin-top:8px';
  row.innerHTML = `
    <div style="flex:0 0 120px">
      <label style="font-weight:600;font-size:0.85rem;margin-bottom:4px;display:block">Qty</label>
      <input type="number" class="lamp-qty" value="${defaultQty}" min="1" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd">
    </div>
    <div style="flex:1">
      <label style="font-weight:600;font-size:0.85rem;margin-bottom:4px;display:block">Pilih Lampu</label>
      <select class="lamp-type" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd">
        ${makeLampOptionsHTML()}
      </select>
    </div>
    <div style="flex:0 0 80px;display:flex;align-items:end;justify-content:flex-end">
      <button class="btn outline remove-lamp">Hapus</button>
    </div>
  `;
  rows.appendChild(row);
  const sel = row.querySelector('.lamp-type');
  sel.value = defaultLampIndex;
  row.querySelector('.remove-lamp').addEventListener('click', ()=> row.remove());
  return row;
}

function addKKKRow(card, defaultLabel='Peralatan', defaultVA=100) {
  const rows = card.querySelector('.kkk-rows');
  const row = document.createElement('div');
  row.className = 'kkk-row';
  row.style.cssText = 'display:flex;gap:8px;margin-top:8px';
  row.innerHTML = `
    <div style="flex:1">
      <label style="font-weight:600;font-size:0.85rem;margin-bottom:4px;display:block">Nama KKK</label>
      <input type="text" class="kkk-label" value="${defaultLabel}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd">
    </div>
    <div style="flex:0 0 140px">
      <label style="font-weight:600;font-size:0.85rem;margin-bottom:4px;display:block">VA</label>
      <input type="number" class="kkk-va" value="${defaultVA}" min="0" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd">
    </div>
    <div style="flex:0 0 80px;display:flex;align-items:end;justify-content:flex-end">
      <button class="btn outline remove-kkk">Hapus</button>
    </div>
  `;
  rows.appendChild(row);
  row.querySelector('.remove-kkk').addEventListener('click', ()=> row.remove());
  return row;
}

// Tombol Tambah Grup
document.getElementById('addGroup').addEventListener('click', ()=>{
  const card = createGroupCard();
  addLampRow(card,1,0);
  addKKKRow(card,'Contoh KKK',100);
});

// Tombol Tambah Grup Contoh
document.getElementById('addExample').addEventListener('click', ()=>{
  const card = createGroupCard();
  addLampRow(card, 2, Math.floor(Math.random()*LAMPS.length));
  addLampRow(card, 1, Math.floor(Math.random()*LAMPS.length));
  addKKKRow(card, 'Pompa Air', 300 + Math.floor(Math.random()*200));
  alert('Grup contoh telah ditambahkan ‚ú®');
});

// Tombol Hitung
calcMode2Btn.addEventListener('click', ()=>{
  resultTableBody.innerHTML = '';
  resultMode2.textContent = '';

  const sistem = document.getElementById('sistemListrik').value;
  const V = sistem === '3' ? 380 : 220;
  const groupCards = Array.from(groupsContainer.querySelectorAll('.mode2-group'));
  if (groupCards.length === 0) return alert('Tambahkan minimal satu grup.');

  let grandW=0, grandVA=0, grandA=0;

  groupCards.forEach((card, i)=>{
    const pf = parseFloat(card.querySelector('.g_pf').value)||0.95;
    const der = parseFloat(card.querySelector('.g_derate').value)||0;

    const lampRows = Array.from(card.querySelectorAll('.lamp-row'));
    let wLamp=0, vaLamp=0, nLamp=0;
    lampRows.forEach(l=>{
      const qty = parseFloat(l.querySelector('.lamp-qty').value)||0;
      const idx = parseInt(l.querySelector('.lamp-type').value);
      const lamp = LAMPS.find(x=>x.index===idx);
      if(!lamp) return;
      nLamp += qty;
      const w = lamp.watt * qty;
      wLamp += w;
      vaLamp += w / pf;
    });

    const kkkRows = Array.from(card.querySelectorAll('.kkk-row'));
    let vaKKK = 0;
    kkkRows.forEach(k=>{
      const v = parseFloat(k.querySelector('.kkk-va').value)||0;
      vaKKK += v;
    });

    const totalVA = (vaLamp + vaKKK) * (1+der/100);
    const I = sistem === '3' ? totalVA / (Math.sqrt(3)*V) : totalVA / V;
    const mcb = recommendMCB(I);

    grandW += wLamp;
    grandVA += totalVA;
    grandA += I;

    card.querySelector('.group-summary').textContent =
      `Lampu: ${nLamp}, Watt: ${wLamp.toFixed(1)}, VA KKK: ${vaKKK}, Total VA: ${totalVA.toFixed(1)}, Arus: ${I.toFixed(2)} A, MCB: ${mcb}A`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>Grup ${i+1}</td>
      <td>${nLamp}</td>
      <td>${vaKKK}</td>
      <td>${wLamp.toFixed(1)}</td>
      <td>${vaLamp.toFixed(1)}</td>
      <td>${totalVA.toFixed(1)}</td>
      <td>${I.toFixed(2)}</td>
      <td>${mcb}A</td>
    `;
    resultTableBody.appendChild(tr);
  });

  const footer = document.createElement('tr');
  footer.innerHTML = `<th colspan="3">TOTAL</th>
    <th>${grandW.toFixed(1)} W</th>
    <th>-</th>
    <th>${grandVA.toFixed(1)} VA</th>
    <th>${grandA.toFixed(2)} A</th>
    <th>${recommendMCB(grandA)}A</th>`;
  resultTableBody.appendChild(footer);

  resultMode2.innerHTML = `
    Sistem: ${sistem==='3'?'3 Fase (380V)':'1 Fase (220V)'}<br>
    Total Watt: ${grandW.toFixed(1)} W<br>
    Total VA: ${grandVA.toFixed(1)} VA<br>
    Total Arus: ${grandA.toFixed(2)} A<br>
    Rekomendasi MCB Utama: ${recommendMCB(grandA)} A
  `;
});
</script>

// ===== MODE 2 =====
const groupsContainer=document.getElementById("groupsContainer");
let groupCount=0;
document.getElementById("addGroup").onclick=()=>{
  groupCount++;
  const div=document.createElement("div");
  div.className="card";
  div.innerHTML=`<strong>Grup ${groupCount}</strong>
  <div class="grid-2">
  <div><label>Jumlah Lampu</label><input type="number" class="jumlah" value="1"></div>
  <div><label>Pilih Lampu</label><select class="lamp"></select></div>
  <div><label>Efisiensi Œ∑</label><input type="number" class="eta" value="0.8" step="0.01"></div>
  <div><button class="btn outline remove">‚ùå Hapus</button></div></div>`;
  const sel=div.querySelector(".lamp");
  LAMPS.forEach(l=>{const o=document.createElement("option");o.value=l.index;o.textContent=l.name;sel.appendChild(o);});
  div.querySelector(".remove").onclick=()=>div.remove();
  groupsContainer.appendChild(div);
};

document.getElementById("calcMode2").onclick=()=>{
  const rows=[];
  let totalW=0,totalVA=0,totalA=0;
  groupsContainer.querySelectorAll(".card").forEach((grp,i)=>{
    const jml=parseFloat(grp.querySelector(".jumlah").value);
    const lamp=LAMPS.find(l=>l.index==parseInt(grp.querySelector(".lamp").value));
    const eta=parseFloat(grp.querySelector(".eta").value);
    const watt=jml*lamp.watt;
    const VA=watt/eta;
    const A=watt/220;
    totalW+=watt; totalVA+=VA; totalA+=A;
    const mcb=A<=6?6:A<=10?10:A<=16?16:A<=20?20:A<=25?25:32;
    rows.push(<tr><td>Grup ${i+1}</td><td>${jml}</td><td>${lamp.name}</td><td>${watt}</td><td>${VA.toFixed(2)}</td><td>${A.toFixed(2)}</td><td>${mcb}A</td></tr>);
  });
  document.querySelector("#resultTable tbody").innerHTML=rows.join("")+<tr><th colspan=3>Total</th><th>${totalW}</th><th>${totalVA.toFixed(2)}</th><th>${totalA.toFixed(2)}</th><th>-</th></tr>;
  document.getElementById("resultMode2").textContent=Total Daya: ${totalW}W | Total Arus: ${totalA.toFixed(2)}A | MCB Utama: ${totalA<=6?6:totalA<=10?10:totalA<=16?16:totalA<=20?20:totalA<=25?25:32}A;
};

document.getElementById("year").textContent=new Date().getFullYear();
</script>
</body>
</html>
