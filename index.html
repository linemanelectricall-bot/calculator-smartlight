<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Lighting Planner</title>
<style>
:root{
  --primary:#00aaff;
  --primary-2:#0077cc;
  --bg:#f5f7fa;
  --card:#ffffff;
  --text:#1e1e2e;
  --muted:#666;
  --border:#e0e6ef;
  --danger:#ff4d4f;
}
body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); transition:background .25s,color .25s}
.dark{background:#12121a;color:#eaeef8}
.header{
  background:linear-gradient(90deg,var(--primary-2),var(--primary));
  color:#fff;padding:30px 18px 40px;border-bottom-left-radius:12px;border-bottom-right-radius:12px;
  box-shadow:0 6px 24px rgba(0,0,0,0.12); position:relative;
}
.header h1{margin:0;font-size:1.6rem}
.header p{margin:6px 0 0;opacity:.95}
.toggle-dark{
  position:absolute; right:16px; top:16px; background:rgba(255,255,255,0.12); border:none; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
}
.container{max-width:1100px;margin:22px auto;padding:0 16px}
.card{background:var(--card); border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(16,24,40,0.06); margin-bottom:18px; transition:background .25s}
.dark .card{background:#1f1f2a; box-shadow:0 4px 12px rgba(0,0,0,0.35)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
.btn.primary{background:var(--primary);color:#fff}
.btn.ghost{background:transparent;border:2px solid var(--primary);color:var(--primary)}
.btn.warn{background:var(--danger);color:#fff}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media(max-width:720px){.grid-2{grid-template-columns:1fr}}
label{display:block;font-weight:700;margin-bottom:6px;font-size:.95rem}
input[type="number"],select,input[type="text"]{
  width:100%; padding:9px 10px;border-radius:8px;border:1px solid var(--border); font-size:0.95rem; background:transparent;
}
.dark input[type="number"],.dark select,.dark input[type="text"]{background:#111218;border-color:#2b2b35;color:#eaeef8}
.small{font-size:0.9rem;color:var(--muted)}
.result-block{font-family:monospace;background:rgba(0,0,0,0.03);padding:12px;border-radius:8px;margin-top:12px}
.dark .result-block{background:rgba(255,255,255,0.03)}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border:1px solid var(--border);text-align:center;font-size:.95rem}
th{background:linear-gradient(90deg,var(--primary-2),var(--primary));color:#fff}
.group-card{border-left:4px solid var(--primary); padding:12px;border-radius:10px;margin-bottom:12px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1 1 220px}
.controls-inline{display:flex;gap:8px;align-items:center}
.kecil{padding:6px 8px;font-size:.9rem;border-radius:8px}
.footer{margin-top:24px;text-align:center;color:var(--muted);font-weight:600;padding:18px}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.06);font-weight:700}
.help{font-size:0.9rem;color:var(--muted);margin-top:8px}
.icon-btn{background:transparent;border:1px solid var(--border);padding:6px 8px;border-radius:8px;cursor:pointer}
.small-muted{font-size:0.85rem;color:var(--muted)}
/* small responsive tweaks */
@media(max-width:480px){.header h1{font-size:1.2rem}.toggle-dark{top:10px;right:10px}}
</style>
</head>
<body>
  <header class="header">
    <h1>Smart Lighting Planner</h1>
    <p>Hitung kebutuhan pencahayaan ruangan dengan cepat & hitung total daya Lampu & KKK dengan cepat.</p>
    <button id="toggleDark" class="toggle-dark" title="Toggle dark mode">ðŸŒ™</button>
  </header>

  <main class="container">
    <!-- MODE SWITCH -->
    <div class="card" style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnMode1" class="btn primary">Lampu per titik</button>
        <button id="btnMode2" class="btn ghost">KKK & lampu. MCB</button>
        <span class="small-muted">Pilih salah satu untuk menentukan titik lampu atau total daya lampu & KKK -_-</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="badge">v1.0</span>
        <img src="" id="logoFooterSmall" alt="" style="height:30px;opacity:.9;display:none">
      </div>
    </div>

    <!-- MODE 1 -->
    <section id="mode1" class="card">
      <div class="grid-2">
        <div>
          <label>Kategori Ruangan</label>
          <select id="kategori"></select>
        </div>
        <div>
          <label>Jenis Ruangan</label>
          <select id="ruangan"><option value="">-- Pilih Kategori dulu --</option></select>
        </div>
        <div>
          <label>Panjang (m)</label>
          <input id="length" type="number" min="0" step="0.1" placeholder="Panjang ruangan (m)">
        </div>
        <div>
          <label>Lebar (m)</label>
          <input id="width" type="number" min="0" step="0.1" placeholder="Lebar ruangan (m)">
        </div>
        <div>
          <label>Efisiensi Î· (0-1)</label>
          <input id="eta" type="number" step="0.01" value="0.8" min="0.1" max="1">
        </div>
        <div>
          <label>Pilih Lampu</label>
          <select id="lampSelect"></select>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="calcMode1" class="btn primary">Hitung & Layout</button>
        <button id="reset1" class="btn" style="border:1px solid var(--border)">Reset</button>
        <div class="small-muted" style="align-self:center">SVG layout akan muncul di bawah hasil.</div>
      </div>

      <div id="warning1" class="help" style="display:none;color:var(--danger);font-weight:700"></div>

      <pre id="resultMode1" class="result-block" style="min-height:60px"></pre>

      <svg id="lampLayout" viewBox="0 0 600 400" style="width:100%;height:300px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:linear-gradient(180deg,#fff,rgba(0,0,0,0.01))"></svg>
    </section>

    <!-- MODE 2 -->
    <section id="mode2" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="addGroupBtn" class="btn primary">Tambah Grup</button>
          <button id="clearGroups" class="btn" style="border:1px solid var(--border)">Bersihkan Semua</button>
          <span class="small-muted">Setiap grup bisa memiliki beberapa baris Lampu dan KKK.</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label class="small-muted" style="margin:0 6px 0 0">MCB Utama</label>
          <select id="mcbMainSelect" class="kecil">
            <option value="1p">1P (Single Phase)</option>
            <option value="3p">3P (Three Phase)</option>
          </select>
        </div>
      </div>

      <p class="help">Di setiap grup: gunakan tombol <strong>+ Tambah Lampu</strong> untuk menambah baris lampu, dan <strong>+ Tambah KKK</strong> untuk menambah peralatan lain (VA).</p>

      <!-- Container grup -->
      <div id="groupsContainer"></div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button id="calcMode2" class="btn primary">Hitung </button>
        <button id="exportJSON" class="btn ghost">Export JSON</button>
        <div id="calcNote" class="small-muted">(^_^)</div>
      </div>

      <div id="resultMode2" class="result-block" style="min-height:80px;margin-top:12px">Hasil.</div>

      <div class="table-wrap" style="margin-top:12px">
        <table id="resultTable">
          <thead>
            <tr>
              <th>Grup</th>
              <th>Jumlah Lampu</th>
              <th>Jumlah KKK</th>
              <th>Total Watt Lampu (W)</th>
              <th>Total VA KKK (VA)</th>
              <th>Total VA (VA)</th>
              <th>Arus (A)</th>
              <th>Rek. MCB</th>
            </tr>
          </thead>
          <tbody>
            <!-- Diisi Part 2 -->
          </tbody>
        </table>
      </div>
    </section>

    <footer class="footer card">
      <div style="display:flex;justify-content:center;gap:12px;align-items:center;flex-wrap:wrap">
        <div>&copy; <span id="year"></span> by <strong>@bah</strong></div>
        <div class="small-muted"></div>
      </div>
    </footer>
  </main>

<script>
/* =======================
   Data (Rooms & Lamps)
   ======================= */
const ROOMS = [
  {key:"teras_rumah", name:"Teras (Rumah Tinggal). lux: 100", kategori:"Rumah Tinggal.", lux:100},
  {key:"ruang_tamu", name:"Ruang Tamu (Rumah Tinggal). lux: 150", kategori:"Rumah Tinggal.", lux:150},
  {key:"kamar_tidur", name:"Kamar Tidur (Rumah Tinggal). lux: 150", kategori:"Rumah Tinggal.", lux:150},
  {key:"dapur", name:"Dapur (Rumah Tinggal). lux: 250", kategori:"Rumah Tinggal.", lux:250},
  {key:"garasi", name:"Garasi (Rumah Tinggal). lux: 75", kategori:"Rumah Tinggal.", lux:75},
  {key:"koridor_rumah", name:"Koridor (Rumah Tinggal). lux: 100", kategori:"Rumah Tinggal.", lux:100},

  {key:"ruang_rapat", name:"Ruang Rapat (Perkantoran). lux: 300", kategori:"Perkantoran.", lux:300},
  {key:"ruang_direktur", name:"Ruang Direktur (Perkantoran). lux: 350", kategori:"Perkantoran.", lux:350},
  {key:"open_office", name:"Open Office (Perkantoran). lux: 350", kategori:"Perkantoran.", lux:350},
  {key:"ruang_komputer", name:"Ruang Komputer (Perkantoran). lux: 500", kategori:"Perkantoran.", lux:500},
  {key:"resepsionis", name:"Resepsionis (Perkantoran). lux: 300", kategori:"Perkantoran.", lux:300},

  {key:"kelas", name:"Ruang Kelas (Lembaga Pendidikan). lux: 300", kategori:"Lembaga Pendidikan.", lux:300},
  {key:"lab_komputer", name:"Laboratorium Komputer (Lembaga Pendidikan). lux: 500", kategori:"Lembaga Pendidikan.", lux:500},
  {key:"perpustakaan", name:"Perpustakaan (Lembaga Pendidikan). lux: 300", kategori:"Lembaga Pendidikan.", lux:300},
  {key:"ruang_gambar", name:"Ruang Gambar (Lembaga Pendidikan). lux: 750", kategori:"Lembaga Pendidikan.", lux:750},

  {key:"kamar_hotel", name:"Kamar Hotel (Hotel & Restoran). lux: 150", kategori:"Hotel & Restoran.", lux:150},
  {key:"lobi_hotel", name:"Lobi Hotel (Hotel & Restoran). lux: 200", kategori:"Hotel & Restoran.", lux:200},
  {key:"ruang_makan", name:"Ruang Makan (Hotel & Restoran). lux: 200", kategori:"Hotel & Restoran.", lux:200},
  {key:"dapur_restoran", name:"Dapur Restoran (Hotel & Restoran). lux: 500", kategori:"Hotel & Restoran.", lux:500},

  {key:"ruang_operasi", name:"Ruang Operasi (Rumah Sakit). lux: 1000", kategori:"Rumah Sakit.", lux:1000},
  {key:"icu", name:"ICU (Rumah Sakit). lux: 300", kategori:"Rumah Sakit.", lux:300},
  {key:"rawat_inap", name:"Ruang Rawat Inap (Rumah Sakit). lux: 200", kategori:"Rumah Sakit.", lux:200},
  {key:"lab_klinik", name:"Laboratorium Klinik (Rumah Sakit). lux: 750", kategori:"Rumah Sakit.", lux:750},

  {key:"produksi_kasar", name:"Produksi Kasar (Industri). lux: 200", kategori:"Industri.", lux:200},
  {key:"perakitan_presisi", name:"Perakitan Presisi (Industri). lux: 1000", kategori:"Industri.", lux:1000},
  {key:"gudang", name:"Gudang (Industri). lux: 150", kategori:"Industri.", lux:150},
  {key:"ruang_kontrol", name:"Ruang Kontrol (Industri). lux: 500", kategori:"Industri.", lux:500},

  {key:"supermarket", name:"Supermarket (Pertokoan & Mall). lux: 750", kategori:"Pertokoan & Mall.", lux:750},
  {key:"etalase", name:"Etalase / Display (Pertokoan & Mall). lux: 1000", kategori:"Pertokoan & Mall.", lux:1000},
  {key:"area_kasir", name:"Area Kasir (Pertokoan & Mall). lux: 500", kategori:"Pertokoan & Mall.", lux:500},
  {key:"foodcourt", name:"Foodcourt (Pertokoan & Mall). lux: 300", kategori:"Pertokoan & Mall.", lux:300},

  {key:"jalan_utama", name:"Jalan Utama (Outdoor). lux: 20", kategori:"Jalan & Transportasi.", lux:20},
  {key:"jalan_lingkungan", name:"Jalan Lingkungan (Outdoor). lux: 10", kategori:"Jalan & Transportasi.", lux:10},
  {key:"terminal", name:"Terminal (Jalan & Transportasi). lux: 150", kategori:"Jalan & Transportasi.", lux:150},
  {key:"bandara", name:"Bandara / Ruang Tunggu (Jalan & Transportasi). lux: 300", kategori:"Jalan & Transportasi.", lux:300}
];

const LAMPS = [
  {index:0,name:"LED Philips 3W. lumen: 240",watt:3,lumen:240},
  {index:1,name:"LED Philips 5W. lumen: 450",watt:5,lumen:450},
  {index:2,name:"LED Philips 7W. lumen: 600",watt:7,lumen:600},
  {index:3,name:"LED Philips 9W. lumen: 800",watt:9,lumen:800},
  {index:4,name:"LED Philips 12W. lumen: 1055",watt:12,lumen:1055},
  {index:5,name:"LED Philips 15W. lumen: 1300",watt:15,lumen:1300},
  {index:6,name:"LED Osram 10W. lumen: 900",watt:10,lumen:900},
  {index:7,name:"LED Osram 20W. lumen: 1800",watt:20,lumen:1800},
  {index:8,name:"Downlight LED 12W. lumen: 1000",watt:12,lumen:1000},
  {index:9,name:"Downlight LED 18W. lumen: 1500",watt:18,lumen:1500},
  {index:10,name:"Lampu TL 36W. lumen: 3350",watt:36,lumen:3350},
  {index:11,name:"Lampu TL 58W. lumen: 4000",watt:58,lumen:4000},
  {index:12,name:"Floodlight LED 30W. lumen: 2700",watt:30,lumen:2700},
  {index:13,name:"Floodlight LED 50W. lumen: 4500",watt:50,lumen:4500},
  {index:14,name:"Floodlight LED 70W. lumen: 6300",watt:70,lumen:6300},
  {index:15,name:"Floodlight LED 100W. lumen: 9000",watt:100,lumen:9000},
  {index:16,name:"Spotlight LED 5W. lumen: 400",watt:5,lumen:400},
  {index:17,name:"Spotlight LED 10W. lumen: 900",watt:10,lumen:900}
];
  

/* =======================
   DOM Refs
   ======================= */
const kategoriEl = document.getElementById('kategori');
const ruanganEl = document.getElementById('ruangan');
const lampSelect = document.getElementById('lampSelect');
const yearEl = document.getElementById('year');
const toggleDarkBtn = document.getElementById('toggleDark');
const mode1Sec = document.getElementById('mode1');
const mode2Sec = document.getElementById('mode2');
const btnMode1 = document.getElementById('btnMode1');
const btnMode2 = document.getElementById('btnMode2');
const lampLayoutSVG = document.getElementById('lampLayout');
const resultMode1 = document.getElementById('resultMode1');
const warning1 = document.getElementById('warning1');

const groupsContainer = document.getElementById('groupsContainer');
const addGroupBtn = document.getElementById('addGroupBtn');
const clearGroupsBtn = document.getElementById('clearGroups');
const mcbMainSelect = document.getElementById('mcbMainSelect');
const exportJSONBtn = document.getElementById('exportJSON');

/* =======================
   Init UI data
   ======================= */
yearEl.textContent = new Date().getFullYear();

/* populate kategori */
(function initCategories(){
  const ks = [...new Set(ROOMS.map(r => r.kategori))];
  kategoriEl.innerHTML = '<option value="">-- Pilih Kategori --</option>';
  ks.forEach(k=>{
    const o = document.createElement('option');
    o.value = k; o.textContent = k;
    kategoriEl.appendChild(o);
  });
})();

/* populate lampSelect */
(function initLamps(){
  lampSelect.innerHTML = '';
  LAMPS.forEach(l=>{
    const o=document.createElement('option');
    o.value = l.index; o.textContent = `${l.name} [${l.watt}W | ${l.lumen} lm]`;
    lampSelect.appendChild(o);
  });
})();

/* when kategori change, populate ruangan */
kategoriEl.addEventListener('change', ()=>{
  const k = kategoriEl.value;
  ruanganEl.innerHTML = '<option value="">-- Pilih Ruangan --</option>';
  ROOMS.filter(r => r.kategori === k).forEach(r=>{
    const o = document.createElement('option');
    o.value = r.key; o.textContent = r.name;
    ruanganEl.appendChild(o);
  });
});

/* =============
   Dark mode
   ============= */
toggleDarkBtn.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  toggleDarkBtn.textContent = document.body.classList.contains('dark') ? 'â˜€' : 'ðŸŒ™';
});

/* =============
   Mode switch
   ============= */
btnMode1.addEventListener('click', ()=>{
  mode1Sec.style.display = ''; mode2Sec.style.display = 'none';
  btnMode1.classList.add('primary'); btnMode2.classList.remove('primary');
});
btnMode2.addEventListener('click', ()=>{
  mode2Sec.style.display = ''; mode1Sec.style.display = 'none';
  btnMode2.classList.add('primary'); btnMode1.classList.remove('primary');
});

/* =======================
   Mode 1 â€” logic (fully functional in Part 1)
   ======================= */
document.getElementById('calcMode1').addEventListener('click', ()=>{
  const rKey = ruanganEl.value;
  const lIdx = parseInt(lampSelect.value);
  const len = parseFloat(document.getElementById('length').value);
  const wid = parseFloat(document.getElementById('width').value);
  const eta = parseFloat(document.getElementById('eta').value) || 0.8;

  if(!rKey || isNaN(lIdx) || !len || !wid){
    alert('Lengkapi semua input Mode 1: kategori, ruangan, panjang, lebar, dan pilih lampu.');
    return;
  }

  const room = ROOMS.find(r => r.key === rKey);
  const lamp = LAMPS.find(l => l.index === lIdx);
  const area = len * wid;
  const totalLumNeeded = (room.lux * area) / eta;
  const lampCount = Math.ceil(totalLumNeeded / lamp.lumen);
  const totalWatt = lampCount * lamp.watt;
  const arus = totalWatt / 220;

  // draw simple grid layout
  lampLayoutSVG.innerHTML = '';
  const cols = Math.ceil(Math.sqrt(lampCount));
  const rows = Math.ceil(lampCount / cols);
  for(let i=0;i<lampCount;i++){
    const r = Math.floor(i/cols), c = i % cols;
    const cx = ((c+1)/(cols+1)) * 600;
    const cy = ((r+1)/(rows+1)) * 400;
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx', cx);
    circle.setAttribute('cy', cy);
    circle.setAttribute('r', 10);
    circle.setAttribute('fill', i%2 === 0 ? '#00aaff' : '#0077cc');
    lampLayoutSVG.appendChild(circle);
  }

  warning1.style.display = 'none';
  if(lampCount % cols !== 0){
    warning1.style.display = '';
    warning1.textContent = 'âš  Jumlah lampu tidak merata dalam grid â€” pertimbangkan penyesuaian posisi atau jenis lampu.';
  }

  resultMode1.textContent =
`Ruangan : ${room.name}
Luas    : ${area.toFixed(2)} mÂ²
Lux     : ${room.lux} lx
Lampu   : ${lamp.name}
Jumlah  : ${lampCount} pcs
Total Watt : ${totalWatt} W
Arus       : ${arus.toFixed(2)} A
Hasil penghiitungan ini dilakukan berdasarkan PUIL & SNI`;
});

document.getElementById('reset1').addEventListener('click', ()=>{
  document.querySelectorAll('#mode1 input, #mode1 select').forEach(el => {
    if(el.tagName.toLowerCase()==='select') el.selectedIndex = 0;
    else el.value = '';
  });
  lampLayoutSVG.innerHTML = '';
  resultMode1.textContent = '';
  warning1.style.display = 'none';
});

/* =======================
   Mode 2 â€” UI: add groups, add lamp rows, add KKK rows
   (Perhitungan akan dibuat di Part 2)
   ======================= */

let groupCounter = 0;

/* helper create element from html */
function createEl(html){
  const t = document.createElement('div'); t.innerHTML = html.trim(); return t.firstElementChild;
}

/* add a new group card (UI only in Part 1) */
function addGroup(initialData){
  groupCounter++;
  const id = `group-${groupCounter}`;
  const groupEl = createEl(`
    <div class="group-card card" id="${id}">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <strong>Grup ${groupCounter}</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn icon-btn kecil btn-add-lamp" title="Tambah baris lampu">+ Lampu</button>
          <button class="btn icon-btn kecil btn-add-kkk" title="Tambah baris KKK">+ KKK</button>
          <button class="btn warn kecil btn-remove" title="Hapus grup">Hapus Grup</button>
        </div>
      </div>

      <div class="help small-muted" style="margin-top:8px">Tambahkan satu atau beberapa baris Lampu dan/atau KKK.</div>

      <div class="group-rows" style="margin-top:12px"></div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <div class="small-muted">Efisiensi default Î· = <input type="number" class="etaField kecil" value="0.8" step="0.01" style="width:70px;margin-left:6px"></div>
        <div class="small-muted">Catatan: kolom hasil akan tampil setelah perhitungan .</div>
      </div>
    </div>
  `);

  /* row container */
  const rowsContainer = groupEl.querySelector('.group-rows');

  /* function to add a lamp row */
  function addLampRow(data){
    const row = createEl(`
      <div class="row" style="align-items:center;border-top:1px dashed rgba(0,0,0,0.06);padding-top:10px;margin-top:10px">
        <div>
          <label>Jumlah Lampu</label>
          <input type="number" class="inp-jumlah-lamp" min="0" step="1" value="${data && data.jumlahLamp ? data.jumlahLamp : 1}">
        </div>
        <div>
          <label>Pilih Lampu</label>
          <select class="sel-lamp"></select>
        </div>
        <div>
          <label>Catatan / Lokasi</label>
          <input type="text" class="inp-lamp-note" placeholder="Mis. Plafon ruang tamu" value="${data && data.note ? data.note : ''}">
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <button class="btn outline kecil btn-remove-row">Hapus Baris</button>
          <div class="small-muted">Watt otomatis </div>
        </div>
      </div>
    `);
    const selLamp = row.querySelector('.sel-lamp');
    LAMPS.forEach(l => { const o = document.createElement('option'); o.value = l.index; o.textContent = `${l.name} [${l.watt}W]`; selLamp.appendChild(o);});
    if(data && data.lampIndex !== undefined) selLamp.value = data.lampIndex;
    row.querySelector('.btn-remove-row').addEventListener('click', ()=> row.remove());
    rowsContainer.appendChild(row);
    return row;
  }

  /* function to add a KKK row */
  function addKKKRow(data){
    const row = createEl(`
      <div class="row" style="align-items:center;border-top:1px dashed rgba(0,0,0,0.06);padding-top:10px;margin-top:10px">
        <div>
          <label>Nama KKK (peralatan)</label>
          <input type="text" class="inp-kkk-name" placeholder="Mis. AC 1PK, Kulkas, TV" value="${data && data.name ? data.name : ''}">
        </div>
        <div>
          <label>VA (mis. 1000)</label>
          <input type="number" class="inp-kkk-va" min="0" step="1" value="${data && data.va ? data.va : 1000}">
        </div>
        <div>
          <label>Qty</label>
          <input type="number" class="inp-kkk-qty" min="1" step="1" value="${data && data.qty ? data.qty : 1}">
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <button class="btn outline kecil btn-remove-row-kkk">Hapus Baris</button>
          <div class="small-muted">Total VA (Part 2)</div>
        </div>
      </div>
    `);
    row.querySelector('.btn-remove-row-kkk').addEventListener('click', ()=> row.remove());
    rowsContainer.appendChild(row);
    return row;
  }

  /* events */
  groupEl.querySelector('.btn-add-lamp').addEventListener('click', ()=> addLampRow());
  groupEl.querySelector('.btn-add-kkk').addEventListener('click', ()=> addKKKRow());
  groupEl.querySelector('.btn-remove').addEventListener('click', ()=> groupEl.remove());

  /* if initialData provided, populate */
  if(initialData && Array.isArray(initialData.lamps)){
    initialData.lamps.forEach(l => addLampRow(l));
  } else {
    addLampRow(); // default one lamp row
  }
  if(initialData && Array.isArray(initialData.kkk)){
    initialData.kkk.forEach(k => addKKKRow(k));
  }

  groupsContainer.appendChild(groupEl);
  return groupEl;
}

/* addGroupBtn handler */
addGroupBtn.addEventListener('click', ()=>{
  addGroup();
});

/* clear all groups */
clearGroupsBtn.addEventListener('click', ()=>{
  if(!confirm('Hapus semua grup?')) return;
  groupsContainer.innerHTML = '';
  groupCounter = 0;
});

/* export JSON (UI snapshot) */
exportJSONBtn.addEventListener('click', ()=>{
  const out = [];
  document.querySelectorAll('.group-card').forEach(g=>{
    const gObj = { lamps:[], kkk:[], eta: parseFloat(g.querySelector('.etaField').value) || 0.8 };
    g.querySelectorAll('.inp-jumlah-lamp').forEach((el, idx)=>{
      const sel = g.querySelectorAll('.sel-lamp')[idx];
      gObj.lamps.push({ jumlahLamp: parseInt(el.value) || 0, lampIndex: parseInt(sel.value), note: g.querySelectorAll('.inp-lamp-note')[idx].value || ''});
    });
    g.querySelectorAll('.inp-kkk-name').forEach((el, idx)=>{
      const va = g.querySelectorAll('.inp-kkk-va')[idx];
      const qty = g.querySelectorAll('.inp-kkk-qty')[idx];
      gObj.kkk.push({ name: el.value || '', va: parseInt(va.value) || 0, qty: parseInt(qty.value) || 1 });
    });
    out.push(gObj);
  });
  const json = JSON.stringify({ mcbMain: mcbMainSelect.value, groups: out }, null, 2);
  // show in result area (Part 1)
  document.getElementById('resultMode2').textContent = json;
});

/* calcMode2 currently placeholder (Part 2 will replace with full logic) */
document.getElementById('calcMode2').addEventListener('click', ()=>{
  alert('Perhitungan Mode 2 (agregasi VA, arus, dan rekomendasi MCB 1P/3P) akan diaktifkan di PART 2.\n\nSaat ini UI sudah siap: kamu bisa tambah grup, lampu, dan KKK. Klik Export JSON untuk melihat data grup.');
});

/* If you want, add an initial sample group so UI doesn't look empty */
addGroup({
  lamps: [{ jumlahLamp:2, lampIndex:3, note:'Plafon ruang tamu' }],
  kkk: [{ name:'AC 1PK', va:1000, qty:1 }],
  eta:0.8
});

/* =======================
   End of Part 1
   ======================= */
</script>
</body>
</html>

<!-- ===== PART 2: MODE 2 LOGIC (paste & replace placeholder calcMode2) ===== -->
<script>
// helper: pilih MCB terdekat sesuai ukuran pabrikan umum
function pickMCB(requiredA) {
  if (!isFinite(requiredA) || requiredA <= 0) return '-';

  const safetyFactor = 1.25; // 25% margin aman
  const need = requiredA * safetyFactor;

  // Daftar ukuran MCB umum dari berbagai pabrikan (Schneider, ABB, Legrand, Chint, dll)
  const MCB_SIZES = [2, 4, 6, 10, 16, 20, 25, 32, 40, 50, 63, 80, 100, 125, 160];

  // Cari ukuran pertama yang lebih besar atau sama
  for (const size of MCB_SIZES) {
    if (need <= size) return `${size} A`;
  }

  // Kalau lebih besar dari 160 A, bulatkan ke kelipatan 25 A (misal 175, 200, 225, dst)
  const rounded = Math.ceil(need / 25) * 25;
  return `${rounded} A`;
}


// formatting helpers
function f(n, d=2){ return (isFinite(n)? n.toFixed(d) : '-') }
function toNumber(v){ const n = parseFloat(v); return isNaN(n) ? 0 : n; }

/* Replace earlier placeholder click handler with the real calc */
const calcBtn = document.getElementById('calcMode2');
if(calcBtn){
  // remove old handlers to avoid duplication
  calcBtn.replaceWith(calcBtn.cloneNode(true));
}
const newCalcBtn = document.getElementById('calcMode2');

newCalcBtn.addEventListener('click', ()=>{

  const rows = [];
  let grandTotalWattLamp = 0;
  let grandTotalVAKKK = 0;
  let grandTotalVA = 0;
  let grandTotalA_perPhase_equiv = 0; // for 3p we track total VA then compute

  const mainMCBType = (document.getElementById('mcbMainSelect') || mcbMainSelect).value; // '1p' or '3p'

  // iterate group cards
  const groupEls = document.querySelectorAll('.group-card');
  if(groupEls.length === 0){
    alert('Belum ada grup. Tambah minimal 1 grup dulu.');
    return;
  }

  groupEls.forEach((g, gi) => {
    const eta = toNumber(g.querySelector('.etaField')?.value) || 0.8;

    // Lamps
    const lampQtyEls = g.querySelectorAll('.inp-jumlah-lamp');
    const lampSelEls = g.querySelectorAll('.sel-lamp');
    let totalWattLamp = 0;
    let totalLampCount = 0;
    lampQtyEls.forEach((qtyEl, idx) => {
      const qty = Math.max(0, Math.floor(toNumber(qtyEl.value)));
      const sel = lampSelEls[idx];
      const lampIndex = sel ? parseInt(sel.value) : 0;
      const lampObj = LAMPS.find(l => l.index === lampIndex);
      const wattPer = lampObj ? lampObj.watt : 0;
      totalWattLamp += (qty * wattPer);
      totalLampCount += qty;
    });

    // KKK
    const kkkNameEls = g.querySelectorAll('.inp-kkk-name');
    const kkkVaEls = g.querySelectorAll('.inp-kkk-va');
    const kkkQtyEls = g.querySelectorAll('.inp-kkk-qty');
    let totalVAKKK = 0;
    let totalKKKCount = 0;
    kkkNameEls.forEach((nameEl, idx) => {
      const va = Math.max(0, toNumber(kkkVaEls[idx].value));
      const qty = Math.max(0, Math.floor(toNumber(kkkQtyEls[idx].value) || 0));
      totalVAKKK += (va * qty);
      totalKKKCount += qty;
    });

    // VA from lamps: convert watt -> VA via eta
    const vaFromLamps = eta > 0 ? (totalWattLamp / eta) : totalWattLamp;
    const totalVA = vaFromLamps + totalVAKKK;

    // Arus per grup depends on 1P/3P selection for MCB utama recommendation,
    // but per-group arus we show using 1P reference (I = VA / 220)
    const I_single_phase = totalVA / 220;
    // For 3P, per-phase current (line current) = VA / (sqrt(3) * VL-L)
    // assume VL-L = 380 V for 3-phase systems (Indonesia typical)
    const I_three_phase = totalVA / (Math.sqrt(3) * 380);

    // choose displayed arus based on mainMCBType (so user sees relevant)
    const displayI = mainMCBType === '3p' ? I_three_phase : I_single_phase;

    // recommended MCB for the group (using displayI)
    const recommendedMCB = pickMCB(displayI);

    // push row data
    rows.push({
      grup: gi + 1,
      jumlahLamp: totalLampCount,
      jumlahKKK: totalKKKCount,
      totalWattLamp: totalWattLamp,
      totalVAKKK: totalVAKKK,
      totalVA: totalVA,
      arusA: displayI,
      recMCB: recommendedMCB,
      eta
    });

    grandTotalWattLamp += totalWattLamp;
    grandTotalVAKKK += totalVAKKK;
    grandTotalVA += totalVA;
    // for grand total current we will compute later based on mainMCBType
  });

  // compute grand totals and main MCB recommendation
  let grandArusDisplay;
  if(mainMCBType === '3p'){
    // per-phase current for 3P main
    grandArusDisplay = grandTotalVA / (Math.sqrt(3) * 380);
  } else {
    // single-phase equivalent current (if everything on single phase)
    grandArusDisplay = grandTotalVA / 220;
  }
  const recMCBMain = pickMCB(grandArusDisplay);

  // render table body
  const tbody = document.querySelector('#resultTable tbody');
  const rowHtml = rows.map(r => {
    return `<tr>
      <td>Grup ${r.grup}</td>
      <td>${r.jumlahLamp}</td>
      <td>${r.jumlahKKK}</td>
      <td>${r.totalWattLamp}</td>
      <td>${r.totalVAKKK}</td>
      <td>${f(r.totalVA,2)}</td>
      <td>${f(r.arusA,2)}</td>
      <td>${r.recMCB}</td>
    </tr>`;
  }).join('');

  const footerRow = `<tr style="font-weight:800">
    <td colspan="3">Total</td>
    <td>${grandTotalWattLamp}</td>
    <td>${grandTotalVAKKK}</td>
    <td>${f(grandTotalVA,2)}</td>
    <td>${f(grandArusDisplay,2)}</td>
    <td>${recMCBMain}</td>
  </tr>`;

  tbody.innerHTML = rowHtml + footerRow;

  // result summary block
  const summaryEl = document.getElementById('resultMode2');
  summaryEl.textContent =
`Total Watt Lampu : ${grandTotalWattLamp} W
Total VA KKK     : ${grandTotalVAKKK} VA
Total VA (gabungan) : ${f(grandTotalVA,2)} VA
MCB Utama Tipe   : ${mainMCBType === '3p' ? '3P (Three Phase)' : '1P (Single Phase)'}
Perkiraan Arus   : ${f(grandArusDisplay,2)} A (${mainMCBType === '3p' ? 'per-fase' : 'total single-phase equivalent'})
Rekomendasi MCB Utama : ${recMCBMain}

(Rekomendasi MCB menggunakan safety factor 1.25 â€” pilih MCB dengan margin aman dan pertimbangkan starting current untuk motor/AC.)`;

  // scroll to table
  tbody.closest('.table-wrap')?.scrollIntoView({behavior:'smooth'});
});

/* Optional: enhance UX â€” update result when MCB type changed */
const mainSel = document.getElementById('mcbMainSelect');
mainSel.addEventListener('change', ()=> {
  // if results exist, re-calc to update display
  if(document.querySelector('#resultTable tbody').children.length > 0){
    document.getElementById('calcMode2').click();
  }
});

/* Also provide quick auto-fill sample for testing (if no groups) */
if(document.querySelectorAll('.group-card').length === 0){
  // nothing
} else {
  // if there are groups from Part1 sample, pre-run once so table shows immediately
  document.getElementById('calcMode2').click();
}

</script>
<!-- ===== END PART 2 ===== -->

